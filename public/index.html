<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PayShield Demo Store</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 40px 20px; }
    .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    h1 { color: #667eea; margin-bottom: 10px; font-size: 2.5em; }
    .subtitle { color: #666; margin-bottom: 40px; font-size: 1.1em; }
    .products { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .product { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; transition: transform 0.2s; }
    .product:hover { transform: translateY(-5px); }
    .product h3 { margin-bottom: 10px; font-size: 1.3em; }
    .product .price { font-size: 1.8em; font-weight: bold; margin: 15px 0; }
    .product button { background: white; color: #667eea; border: none; padding: 12px 25px; border-radius: 25px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.2s; }
    .product button:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .cart { background: #f8f9ff; padding: 30px; border-radius: 15px; margin-top: 20px; }
    .cart h2 { color: #667eea; margin-bottom: 20px; }
    .cart-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #ddd; font-size: 1.1em; }
    .cart-total { font-size: 1.5em; font-weight: bold; color: #667eea; text-align: right; margin-top: 20px; padding-top: 20px; border-top: 2px solid #667eea; }
    .checkout-btn { width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 18px; border-radius: 30px; font-size: 1.3em; font-weight: bold; cursor: pointer; margin-top: 20px; transition: all 0.3s; }
    .checkout-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4); }
    .checkout-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .result { margin-top: 20px; padding: 20px; border-radius: 10px; font-size: 1.1em; line-height: 1.6; }
    .result.success { background: #d4edda; color: #155724; border: 2px solid #c3e6cb; }
    .result.error { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; }
    .result a { color: inherit; font-weight: bold; text-decoration: underline; }
    
    /* MFA Modal */
    #mfa-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; }
    #mfa-modal.show { display: flex; }
    .modal-content { background: white; padding: 40px; border-radius: 20px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-content h2 { color: #667eea; margin-bottom: 15px; font-size: 1.8em; }
    .modal-content p { color: #666; margin-bottom: 30px; font-size: 1.1em; }
    .modal-btn { background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 1.1em; cursor: pointer; margin: 10px; transition: all 0.2s; font-weight: bold; }
    .modal-btn:hover { background: #5568d3; transform: translateY(-2px); }
    .modal-btn.cancel { background: #dc3545; }
    .modal-btn.cancel:hover { background: #c82333; }
    #otp-section { display: none; margin-top: 20px; }
    #otp-input { width: 100%; padding: 15px; font-size: 1.3em; text-align: center; border: 2px solid #667eea; border-radius: 10px; margin-bottom: 15px; letter-spacing: 5px; }
    #mfa-status { margin-top: 20px; color: #667eea; font-weight: bold; min-height: 30px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõ°Ô∏è PayShield Demo Store</h1>
    <p class="subtitle">Experience secure payments with Multi-Factor Authentication</p>

    <div class="products">
      <div class="product">
        <h3>üñ±Ô∏è Wireless Mouse</h3>
        <div class="price">$79.99</div>
        <button onclick="addToCart('Wireless Mouse', 79.99)">Add to Cart</button>
      </div>
      <div class="product">
        <h3>‚å®Ô∏è Mechanical Keyboard</h3>
        <div class="price">$149.99</div>
        <button onclick="addToCart('Mechanical Keyboard', 149.99)">Add to Cart</button>
      </div>
      <div class="product">
        <h3>üíª Premium Laptop</h3>
        <div class="price">$1,299.99</div>
        <button onclick="addToCart('Premium Laptop', 1299.99)">Add to Cart</button>
      </div>
    </div>

    <div class="cart">
      <h2>üõí Your Cart</h2>
      <div id="cart-items"></div>
      <div class="cart-total" id="cart-total">Total: $0.00</div>
      <button class="checkout-btn" id="checkout-btn" onclick="checkout()">üîí Proceed to Secure Checkout</button>
      <div id="result"></div>
    </div>
  </div>

  <!-- MFA Modal -->
  <div id="mfa-modal">
    <div class="modal-content">
      <h2>üîê Secure Your Payment</h2>
      <p>This high-value transaction requires additional verification.</p>
      <div id="mfa-options">
        <button class="modal-btn" onclick="sendOtp()">üì± Send One-Time Code</button>
      </div>
      <div id="otp-section">
        <input type="text" id="otp-input" placeholder="000000" maxlength="6" />
        <button class="modal-btn" onclick="verifyOtp()">‚úì Verify Code</button>
      </div>
      <div id="mfa-status"></div>
      <button class="modal-btn cancel" onclick="cancelMfa()">Cancel</button>
    </div>
  </div>

  <script>
    const BACKEND_URL = window.location.origin;
    const MERCHANT_ID = 'demo_merchant_001';
    let cart = [];
    let currentOrderId = null;

    function addToCart(name, price) {
      cart.push({ name, price });
      renderCart();
      showMessage('');
    }

    function renderCart() {
      const itemsDiv = document.getElementById('cart-items');
      const totalDiv = document.getElementById('cart-total');
      
      if (cart.length === 0) {
        itemsDiv.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">Your cart is empty</div>';
        totalDiv.textContent = 'Total: $0.00';
        return;
      }
      
      itemsDiv.innerHTML = cart.map(item => 
        `<div class="cart-item"><span>${item.name}</span><span>$${item.price.toFixed(2)}</span></div>`
      ).join('');
      
      const total = cart.reduce((sum, item) => sum + item.price, 0);
      totalDiv.textContent = `Total: $${total.toFixed(2)}`;
    }

    function showMessage(msg, isError = false) {
      const resultDiv = document.getElementById('result');
      if (!msg) {
        resultDiv.style.display = 'none';
        return;
      }
      resultDiv.className = `result ${isError ? 'error' : 'success'}`;
      resultDiv.innerHTML = msg;
      resultDiv.style.display = 'block';
    }

    function showModal() {
      document.getElementById('mfa-modal').classList.add('show');
      document.getElementById('otp-section').style.display = 'none';
      document.getElementById('mfa-status').textContent = '';
    }

    function hideModal() {
      document.getElementById('mfa-modal').classList.remove('show');
    }

    function cancelMfa() {
      hideModal();
      showMessage('‚ùå Payment cancelled', true);
      document.getElementById('checkout-btn').disabled = false;
    }

    async function checkout() {
      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }

      const btn = document.getElementById('checkout-btn');
      btn.disabled = true;
      btn.textContent = 'Processing...';
      showMessage('Checking payment requirements...');

      currentOrderId = 'order_' + Date.now();
      const total = cart.reduce((sum, item) => sum + item.price, 0);

      try {
        // Step 1: Preauth
        const preauth = await fetch(`${BACKEND_URL}/api/preauth`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId: MERCHANT_ID,
            orderId: currentOrderId,
            amount: total,
            currency: 'USD'
          })
        }).then(r => r.json());

        console.log('Preauth:', preauth);

        if (!preauth.mfaRequired) {
          // No MFA needed
          showMessage('‚úÖ Payment successful! No MFA required for this amount.');
          cart = [];
          renderCart();
          btn.disabled = false;
          btn.textContent = 'üîí Proceed to Secure Checkout';
          return;
        }

        // Step 2: Show MFA modal
        showMessage('MFA required. Please verify your identity...');
        showModal();

      } catch (error) {
        showMessage('‚ùå Error: ' + error.message, true);
        btn.disabled = false;
        btn.textContent = 'üîí Proceed to Secure Checkout';
      }
    }

    async function sendOtp() {
      document.getElementById('mfa-status').textContent = 'Sending OTP...';
      
      try {
        const result = await fetch(`${BACKEND_URL}/api/send-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId: currentOrderId })
        }).then(r => r.json());

        if (result.success) {
          document.getElementById('otp-section').style.display = 'block';
          document.getElementById('mfa-status').textContent = '‚úÖ OTP sent! Check your terminal.';
          document.getElementById('otp-input').focus();
        } else {
          document.getElementById('mfa-status').textContent = '‚ùå Failed to send OTP';
        }
      } catch (error) {
        document.getElementById('mfa-status').textContent = '‚ùå Error: ' + error.message;
      }
    }

    async function verifyOtp() {
      const otp = document.getElementById('otp-input').value;
      if (!otp || otp.length !== 6) {
        document.getElementById('mfa-status').textContent = '‚ùå Please enter 6-digit code';
        return;
      }

      document.getElementById('mfa-status').textContent = 'Verifying...';

      try {
        const result = await fetch(`${BACKEND_URL}/api/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            merchantId: MERCHANT_ID,
            orderId: currentOrderId,
            otp: otp
          })
        }).then(r => r.json());

        if (result.success) {
          hideModal();
          const receipt = result.mfaReceipt;
          let msg = `‚úÖ Payment Successful!<br><br>
            Order: ${receipt.orderId}<br>
            Method: ${receipt.method.toUpperCase()}<br>
            Receipt: ${receipt.receiptId}<br>
            Hash: ${receipt.approvalHash.substring(0, 20)}...`;
          
          if (receipt.blockchainTx) {
            msg += `<br><br>‚õìÔ∏è <a href="${receipt.blockchainTx.explorerUrl}" target="_blank">View on Blockchain ‚Üó</a>`;
          }
          
          showMessage(msg);
          cart = [];
          renderCart();
        } else {
          document.getElementById('mfa-status').textContent = '‚ùå ' + result.message;
        }
      } catch (error) {
        document.getElementById('mfa-status').textContent = '‚ùå Error: ' + error.message;
      } finally {
        document.getElementById('checkout-btn').disabled = false;
        document.getElementById('checkout-btn').textContent = 'üîí Proceed to Secure Checkout';
      }
    }

    renderCart();
  </script>
</body>
</html>

